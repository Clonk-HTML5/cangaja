var CG=CG||{VERSION:1,Const_PI_180:Math.PI/180,Const_180_PI:180/Math.PI,LEFT:1,RIGHT:2,UP:3,DOWN:4};(function(){var d=0;var e=["ms","moz","webkit","o"];for(var b=0;b<e.length&&!window.requestAnimationFrame;++b){window.requestAnimationFrame=window[e[b]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[e[b]+"CancelAnimationFrame"]||window[e[b]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(m,g){var f=new Date().getTime();var j=Math.max(0,16-(f-d));var k=window.setTimeout(function(){m(f+j)},j);d=f+j;return k}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(f){clearTimeout(f)}}}());(function(){var b=false,d=/xyz/.test(function(){var e})?/\b_super\b/:/.*/;CG.Class=function(){};CG.Class.prototype.isA=function(e){return this.className===e};CG.Class.extend=function(m,f,j){if(!typeof m==="string"){j=f;f=m;m=null}var q=this.prototype,r=this;b=true;var n=new r();b=false;function k(u,v){return function(){var z=this._super;this._super=q[u];var y=v.apply(this,arguments);this._super=z;return y}}for(var g in f){n[g]=typeof f[g]==="function"&&typeof q[g]==="function"&&d.test(f[g])?k(g,f[g]):f[g]}function e(){if(!b&&this.init){this.init.apply(this,arguments)}}e.prototype=n;e.prototype.constructor=e;e.extend=CG.Class.extend;if(j){CG._extend(e,j)}if(m){CG[m]=e;e.prototype.className=m;e.className=m}return e}}());function loadString(b){var d=new XMLHttpRequest();d.open("GET",b,false);d.send(null);if((d.status==200)||(d.status==0)){return d.responseText}return""}String.prototype.ltrim=function(b){if(b){return this.replace(new RegExp("^["+b+"]+"),"")}return this.replace(/^\s+/,"")};String.prototype.rtrim=function(b){if(b){return this.replace(new RegExp("["+b+"]+$"),"")}return this.replace(/\s+$/,"")};String.prototype.trim=function(b){if(b){return this.ltrim(b).rtrim(b)}return this.ltrim().rtrim()};String.prototype.startsWith=function(b){return !this.indexOf(b)};CG.Class.extend("Delta",{init:function(b){this.targetfps=b;this.currentticks=0;this.lastticks=Date.now();this.frametime=0;this.delta=0},update:function(){this.currentticks=Date.now();this.frametime=this.currentticks-this.lastticks;this.delta=this.frametime/(1000/this.targetfps);this.lastticks=this.currentticks},get:function(){return this.delta}});CG.Class.extend("Entity",{init:function(b){this.name=b||"";this.visible=true},update:function(){throw {name:"Entity Error",message:"Subclass has no update method."}},draw:function(){throw {name:"Entity Error",message:"Subclass has no draw method."}},setImage:function(b){this.atlasimage=false;if(b instanceof CG.TPImage){this.image=Game.asset.getImageByName(b.atlasname);this.imagerotation=b.rotation;this.xoffset=b.xoffset;this.yoffset=b.yoffset;this.width=b.width;this.height=b.height;this.atlasimage=true;if(this.imagerotation!==0){this.cutwidth=b.height;this.cutheight=b.width}else{this.cutwidth=b.width;this.cutheight=b.height}}else{if(typeof b=="string"){this.image=new Image();this.image.src=b;this.width=this.image.width;this.height=this.image.height}else{this.image=b;this.width=this.image.width;this.height=this.image.height}}}});CG.Entity.extend("Point",{init:function(b,d){this.x=b||0;this.y=d||0}});CG.Point.extend("Vector",{init:function(b,e,d){this._super(this,b,e);this.z=d||0}});CG.Entity.extend("Rectangle",{init:function(d,e,b){this.position=d||new CG.Point(0,0);this.width=e||0;this.height=b||0;this.clickable=false;this.dragable=false;this.rotation=0;this.xscale=1;this.yscale=1;this.clicked=false;this.hover=false;this.boundingradius=0;this.mapcollision=false;return this},AABB:function(){a=this.rotation*CG.Const_PI_180;s=Math.sin(a);c=Math.cos(a);if(s<0){s=-s}if(c<0){c=-c}return{bw:this.height*this.xscale*s+this.width*this.yscale*c,bh:this.height*this.xscale*c+this.width*this.yscale*s}},ifClicked:function(){if(mousedown&&this.clickable){var e=mousex-this.position.x,b=mousey-this.position.y;var j=Math.sqrt(e*e+b*b);var g=Math.atan2(b,e);var k=g-(this.rotation*CG.Const_PI_180);var d=Math.cos(k)*j;var f=Math.sin(k)*j;if(d>-0.5*(this.width*this.xscale)&&d<0.5*(this.width*this.xscale)&&f>-0.5*(this.height*this.yscale)&&f<0.5*(this.height*this.yscale)){this.clicked=true;mousedown=false}}return false},ifMouseOver:function(){var e=mousex-this.position.x,b=mousey-this.position.y;var j=Math.sqrt(e*e+b*b);var g=Math.atan2(b,e);var k=g-(this.rotation*CG.Const_PI_180);var d=Math.cos(k)*j;var f=Math.sin(k)*j;if(d>-0.5*(this.width*this.xscale)&&d<0.5*(this.width*this.xscale)&&f>-0.5*(this.height*this.yscale)&&f<0.5*(this.height*this.yscale)){this.hover=true}else{this.hover=false}},checkCollision:function(b,d){b.forEach(function(f,e){if(f.className=="MapArea"){if((this.position.y+this.AABB().bh/2)>=f.bound.y&&this.position.y-this.AABB().bh/2<=(f.bound.y+f.bound.height)&&(this.position.x+this.AABB().bw/2)>=f.bound.x&&this.position.x-this.AABB().bw/2<=(f.bound.x+f.bound.width)){if(f.type==="outer"){w=0.5*(this.width+f.bound.width);h=0.5*(this.height+f.bound.height);dx=this.position.x-(f.bound.width/2+f.bound.x);dy=this.position.y-(f.bound.height/2+f.bound.y);if(Math.abs(dx)<=w&&Math.abs(dy)<=h){wy=w*dy;hx=h*dx;if(wy>hx){if(wy>-hx){direction="bottom";overlap=((this.position.y-this.AABB().bh/2)-(f.bound.y+f.bound.height))>>0}else{direction="CG.LEFT";overlap=((this.position.x+this.AABB().bw/2)-f.bound.x)>>0}}else{if(wy>-hx){direction="right";overlap=((this.position.x-this.AABB().bw/2)-(f.bound.x+f.bound.width))>>0}else{direction="top";overlap=((this.position.y+this.AABB().bh/2)-f.bound.y)>>0}}}collision={overlap:overlap,direction:direction};d(this,f,collision)}}}else{if(this.boundingradius>0&&f.boundingradius>0){distx=this.position.x-f.position.x;disty=this.position.y-f.position.y;dist=Math.sqrt((distx*distx)+(disty*disty));if(dist<=(this.boundingradius/2*this.xscale+f.boundingradius/2*f.yscale)){collision=false;d(this,f,collision)}}else{if((this.position.y+this.AABB().bh/2)>=f.position.y-f.AABB().bh/2&&this.position.y-this.AABB().bh/2<=(f.position.y+f.AABB().bh/2)&&(this.position.x+this.AABB().bw/2)>=f.position.x-f.AABB().bw/2&&this.position.x-this.AABB().bw/2<=(f.position.x+f.AABB().bw/2)){w=0.5*(this.width+f.width);h=0.5*(this.height+f.height);dx=this.position.x-f.position.x;dy=this.position.y-f.position.y;if(Math.abs(dx)<=w&&Math.abs(dy)<=h){wy=w*dy;hx=h*dx;if(wy>hx){if(wy>-hx){direction="bottom";overlap=((this.position.y-this.AABB().bh/2)-(f.position.y-f.AABB().bh/2))>>0}else{direction="CG.LEFT";overlap=((this.position.x+this.AABB().bw/2)-(f.position.x+f.AABB().bw/2))>>0}}else{if(wy>-hx){direction="right";overlap=((this.position.x-this.AABB().bw/2)-(f.position.x-f.AABB().bw/2))>>0}else{direction="top";overlap=((this.position.y+this.AABB().bh/2)-(f.position.y+f.AABB().bh/2))>>0}}}collision={overlap:overlap,direction:direction};d(this,f,collision)}}}},this);return this}});CG.Entity.extend("Bound",{init:function(d,f,e,b){this._super();this.x=d;this.y=f;this.width=e;this.height=b;return this},setName:function(b){this.name=b;return this}});CG.Entity.extend("Buffer",{init:function(e,b,d){this._super(d);this.b_canvas=document.createElement("canvas");this.b_canvas.width=e;this.b_canvas.height=b;this.b_ctx=this.b_canvas.getContext("2d");return this}});CG.Rectangle.extend("Sprite",{init:function(d,b){this._super(b,0,0);this.atlasimage=false;this.setImage(d);this.bound=Game.bound;this.diffpoint=new CG.Point(this.bound.x,this.bound.y);this.xspeed=0;this.xscale=1;this.xhandle=0;this.yspeed=0;this.yscale=1;this.yhandle=0;this.boundsMode=false;this.rotation=0;this.rotationspeed=0;this.alpha=1;this.clicked=false;this.followobject=false;this.followspeed=false;this.followsteps=false;this.attachedobject=false;this.offsetx=0;this.offsety=0;return this},update:function(){this.ifClicked();this.ifMouseOver();this.ifAttached();if(this.followobject){this.follow()}this.position.x+=this.xspeed;this.position.y+=this.yspeed;this.rotation+=this.rotationspeed;this.xhandle=(this.width*this.xscale/2);this.yhandle=(this.height*this.yscale/2);if(this.boundsMode){this.checkBound()}},draw:function(){this.updateDiff();Game.b_ctx.save();Game.b_ctx.globalAlpha=this.alpha;Game.b_ctx.translate(this.position.x,this.position.y);if(this.atlasimage){Game.b_ctx.rotate((this.rotation-this.imagerotation)*CG.Const_PI_180);Game.b_ctx.drawImage(this.image,this.xoffset,this.yoffset,this.cutwidth,this.cutheight,0-this.xhandle,0-this.yhandle,this.cutwidth*this.xscale,this.cutheight*this.yscale)}else{Game.b_ctx.rotate(this.rotation*CG.Const_PI_180);Game.b_ctx.drawImage(this.image,0-this.xhandle,0-this.yhandle,this.image.width*this.xscale,this.image.height*this.yscale)}Game.b_ctx.restore()},checkBound:function(){switch(this.boundsMode){case"bounce":if(this.position.x>(this.bound.width-this.xhandle+this.bound.x)){this.position.x=this.bound.width-this.xhandle+this.bound.x;this.xspeed=this.xspeed*-1}else{if(this.position.x<this.bound.x+this.xhandle){this.position.x=this.bound.x+this.xhandle;this.xspeed=this.xspeed*-1}}if(this.position.y>(this.bound.height-this.yhandle+this.bound.y)){this.position.y=this.bound.height-this.yhandle+this.bound.y;this.yspeed=this.yspeed*-1}else{if(this.position.y<this.bound.y+this.yhandle){this.position.y=this.bound.y+this.yhandle;this.yspeed=this.yspeed*-1}}break;case"slide":if(this.position.x>(this.bound.width+this.xhandle+this.bound.x)){this.position.x=(this.bound.x-this.xhandle)}else{if(this.position.x<this.bound.x-this.xhandle){this.position.x=this.bound.x+this.bound.width+this.xhandle}}if(this.position.y>(this.bound.height+this.yhandle+this.bound.y)){this.position.y=(this.bound.y-this.yhandle)}else{if(this.position.y<this.bound.y-this.yhandle){this.position.y=this.bound.height+this.yhandle+this.bound.y}}break;default:break}},updateDiff:function(){if(this.diffpoint.x!==this.bound.x){this.position.x+=this.bound.x-this.diffpoint.x}if(this.diffpoint.y!==this.bound.y){this.position.y+=this.bound.y-this.diffpoint.y}this.diffpoint.x=this.bound.x;this.diffpoint.y=this.bound.y},follow:function(){if(this.followspeed){angl=Math.atan2(this.followobject.position.x-this.position.x,this.followobject.position.y-this.position.y)*CG.Const_180_PI;xs=this.followspeed*Math.sin(angl*CG.Const_PI_180);ys=this.followspeed*Math.cos(angl*CG.Const_PI_180);this.xspeed=xs;this.yspeed=ys;this.rotation=angl*-1}else{if(this.followsteps){angl=Math.atan2(this.followobject.position.x-this.position.x,this.followobject.position.y-this.position.y)*CG.Const_180_PI;this.rotation=angl*-1;if(this.followobject.position.x!=this.position.x){distx=this.followobject.position.x-this.position.x;this.xspeed=distx/this.followsteps}else{this.xspeed=0}if(this.followobject.position.y!=this.position.y){disty=this.followobject.position.y-this.position.y;this.yspeed=disty/this.followsteps}else{this.yspeed=0}}}},setBound:function(b){this.bound=b;return this},ifAttached:function(){if(this.attachedobject!=false){this.attachedobject.position._x=this.attachedobject.position.x=(this.position.x+this.offsetx);this.attachedobject.position._y=this.attachedobject.position.y=(this.position.y+this.offsety)}},attachObject:function(b){this.attachedobject=b;return this},removeAttachedObject:function(){this.attachedobject=false;return this},setAttachedOffsetX:function(b){this.offsetx=b;return this},setAttachedOffsetY:function(b){this.offsety=b;return this}});CG.Class.extend("TPImage",{init:function(f,e,g,d,b){this.source="";this.atlasimage="";this.atlasname="";this.image=f||"";this.name=f.split(/(\\|\/)/g).pop().split(".")[0];this.xoffset=e||0;this.yoffset=g||0;this.width=d||0;this.height=b||0;this.rotation=0}});CG.Class.extend("TexturePacker",{init:function(){if(typeof(ejecta)=="undefined"){this.xml="";this.xmlDoc="";this.parser=new DOMParser()||{}}this.imagename="";this.width=0;this.height=0;this.tpimages=[];return this},loadXml:function(e){if(typeof e=="string"){this.xml=loadString(e)}else{this.xml=e.data}this.xmlDoc=this.parser.parseFromString(this.xml,"text/xml");this.imagename=this.xmlDoc.getElementsByTagName("TextureAtlas")[0].getAttribute("imagePath");this.width=parseInt(this.xmlDoc.getElementsByTagName("TextureAtlas")[0].getAttribute("width"));this.height=parseInt(this.xmlDoc.getElementsByTagName("TextureAtlas")[0].getAttribute("height"));var f=this.xmlDoc.getElementsByTagName("sprite");for(var d=0,b=f.length;d<b;d++){tpimage=new CG.TPImage(f[d].getAttribute("n"),parseInt(f[d].getAttribute("x")),parseInt(f[d].getAttribute("y")),parseInt(f[d].getAttribute("w")),parseInt(f[d].getAttribute("h")));if(f[d].getAttribute("r")=="y"){tpimage.rotation=90}tpimage.atlasimage=this.imagename;tpimage.source="xml";tpimage.atlasname=this.imagename.split(/(\\|\/)/g).pop().split(".")[0];this.tpimages.push(tpimage)}return this},loadJson:function(e){if(typeof e=="string"){this.json=JSON.parse(loadString(e))}else{this.json=e.data}this.imagename=this.json.meta.image;this.width=this.json.meta.size.w;this.height=this.json.meta.size.h;for(var d=0,b=this.json.frames.length;d<b;d++){var g=this.json.frames[d];var f=new CG.TPImage(g.filename,g.frame.x,g.frame.y,g.frame.w,g.frame.h);if(g.rotated===true){f.rotation=90}f.atlasimage=this.imagename;f.source="json";f.atlasname=this.imagename.split(/(\\|\/)/g).pop().split(".")[0];this.tpimages.push(f)}return this},getTPImages:function(){return this.tpimages}});CG.Sprite.extend("Animation",{init:function(g,b,j,f,e,d){this._super(g,b);if(typeof g=="string"){this.image=new Image();this.image.src=g}else{this.image=g}this.loop=true;this.status=0;this.currentframe=0;this.startframe=j-1;this.endframe=f-1;this.width=e;this.height=d;if(this.startframe===undefined&&this.endframe===undefined){this.frames=1;this.startframe=0;this.endframe=0}else{this.currentframe=this.startframe-1;this.frames=this.endframe-this.startframe+1}this.fx=0;this.fy=0;this.delay=0;this.tempdelay=0;return this},update:function(){if(this.status==0){this.tempdelay+=1;if(this.tempdelay>=this.delay){this.tempdelay=0;if(this.frames>1){this.currentframe+=1;if((this.currentframe-this.startframe)>=this.frames){if(this.loop===false){this.status=1}else{this.currentframe=this.startframe}}}}}this._super()},draw:function(){this.updateDiff();Game.b_ctx.save();Game.b_ctx.globalAlpha=this.alpha;Game.b_ctx.translate(this.position.x,this.position.y);if(this.frames==1){Game.b_ctx.drawImage(this.image,this.position.x,this.position.y,this.image.width*this.xscale,this.image.height*this.yscale)}else{this.fx=this.currentframe*this.width;if((this.fx/this.image.width)>0){this.fx=this.fx%this.image.width}this.fy=Math.floor(this.width*this.currentframe/this.image.width)*this.height;Game.b_ctx.rotate(this.rotation*CG.Const_PI_180);try{Game.b_ctx.drawImage(this.image,this.fx,this.fy,this.width,this.height,0-this.xhandle,0-this.yhandle,this.width*this.xscale,this.height*this.yscale)}catch(b){}}Game.b_ctx.restore()}});CG.Entity.extend("Bitmap",{init:function(d,b){this._super(this);this.x=0;this.y=0;this.bitmap_canvas=document.createElement("canvas");this.bitmap_canvas.width=d;this.bitmap_canvas.height=b;this.bitmap_ctx=this.bitmap_canvas.getContext("2d");return this},loadImage:function(b){this.setImage(b);this.drawImageToBuffer();return this},update:function(){},draw:function(){Game.b_ctx.drawImage(this.bitmap_canvas,this.x,this.y)},clearBuffer:function(){this.bitmap_ctx.clearRect(0,0,this.bitmap_canvas.width,this.bitmap_canvas.height);return this},drawImageToBuffer:function(){this.bitmap_ctx.drawImage(this.image,0,0);return this},clearRect:function(d,f,e,b){this.bitmap_ctx.save();this.bitmap_ctx.globalCompositeOperation="destination-out";this.bitmap_ctx.clearRect(d,f,e,b);this.bitmap_ctx.restore()},clearCircle:function(d,e,b){this.bitmap_ctx.save();this.bitmap_ctx.globalCompositeOperation="destination-out";this.bitmap_ctx.beginPath();this.bitmap_ctx.arc(d,e,b,0,2*Math.PI,false);this.bitmap_ctx.closePath();this.bitmap_ctx.fill();this.bitmap_ctx.restore()},getPixel:function(b,d){return this.bitmap_ctx.getImageData(b,d,1,1)},getPixels:function(d,f,e,b){return this.bitmap_ctx.getImageData(d,f,e,b)}});CG.Sprite.extend("Button",{init:function(f,d,g,e,b){this._super(f,d);this.font=e;this.clickedCallback=b;this.clicked=false;this.clickable=true;this.text=g;return this},update:function(){this.ifClicked();this.ifMouseOver();this.ifAttached();if(this.clicked){if(this.clickedCallback){this.clicked=false;this.clickedCallback(this)}}},draw:function(){Game.b_ctx.save();Game.b_ctx.translate(this.position.x,this.position.y);if(this.atlasimage){var b=this.rotation;Game.b_ctx.rotate((b-this.imagerotation)*CG.Const_PI_180);Game.b_ctx.drawImage(this.image,this.xoffset,this.yoffset,this.cutwidth,this.cutheight,0-(this.cutwidth/2),0-(this.cutheight/2),this.cutwidth*this.xscale,this.cutheight*this.yscale);Game.b_ctx.rotate(this.imagerotation*CG.Const_PI_180)}else{Game.b_ctx.rotate(b*CG.Const_PI_180);Game.b_ctx.drawImage(this.image,0-(this.image.width*this.xscale/2),0-(this.image.height*this.yscale/2),this.image.width*this.xscale,this.image.height*this.yscale)}this.font.draw(this.text,0-(this.font.getLength(this.text)/2>>0),0-((this.font.getFontSize()/2)>>0));Game.b_ctx.restore()}});CG.Entity.extend("Menu",{init:function(b,e,d){this.x=b;this.y=e;this.margin=d;this.step=this.y;this.buttons=[];return this},addButton:function(b){this.buttons.push(b)},update:function(){this.buttons.forEach(function(b){b.update()},this)},draw:function(){this.buttons.forEach(function(b){b.position.x=this.x;b.position.y=this.step;b.draw();this.step+=b.height;this.step+=this.margin},this);this.step=this.y}});CG.Class.extend("MediaAsset",{init:function(b){if(b){this.image=new Image();this.image.src=b}this.ready=false;this.images=[];this.currimage=0;this.sounds=[];this.currsound=0;this.xmls=[];this.currxml=0;this.jsons=[];this.currjson=0;this.fonts=[];this.currfont=0;this.assetcount=0;this.assetcurrent=0;this.width=300;this.height=20;this.radius=10;this.linewidth=8;this.bordercolor="white";this.progresscolor="red";this.shadowcolor="#222";this.shadowblur=6;this.shadowoffsetx=2;this.shadowoffsety=2},addImage:function(d,b){this.assetcount+=1;this.images.push({name:b||"",path:d,img:new Image()});return this},addFont:function(d,b){this.assetcount+=1;this.fonts.push({name:b||"",path:d,data:""});return this},addXml:function(d,b){this.assetcount+=1;this.xmls.push({name:b||"",path:d,data:""});return this},addJson:function(d,b){this.assetcount+=1;this.jsons.push({name:b||"",path:d,data:""});return this},getImageByName:function(d){for(var e=0,b=this.images.length;e<b;e++){if(this.images[e].name==d){if(this.images[e] instanceof CG.TPImage){return this.images[e]}else{return this.images[e].img}}}throw new CG.MediaAssetException("No image with this name in asset.")},getImagesByName:function(d){names=[];for(var e=0,b=this.images.length;e<b;e++){if(this.images[e].name==d){if(this.images[e] instanceof CG.TPImage){names.push(this.images[e])}else{names.push(this.images[e].img)}}}if(names.length===0){throw new CG.MediaAssetException("No image with this name in asset.")}return names},getFontByName:function(d){for(var e=0,b=this.fonts.length;e<b;e++){if(this.fonts[e].name==d){return this.fonts[e]}}throw new CG.MediaAssetException("No font with this name in asset.")},getXmlByName:function(d){for(var e=0,b=this.xmls.length;e<b;e++){if(this.xmls[e].name==d){return this.xmls[e]}}throw new CG.MediaAssetException("No XML with this name in asset.")},getJsonByName:function(d){for(var e=0,b=this.jsons.length;e<b;e++){if(this.jsons[e].name==d){return this.jsons[e]}}throw new CG.MediaAssetException("No JSON with this name in asset.")},startPreLoad:function(){progress=100/this.assetcount*this.assetcurrent;this.progressScreen(progress);if(this.currimage<this.images.length){this.images[this.currimage].img.onload=function(){console.log("loaded image ("+Math.floor(100/(this.images.length-1)*this.currimage)+" %): "+this.images[this.currimage].name);this.currimage+=1;this.assetcurrent+=1;this.startPreLoad()}.bind(this);this.images[this.currimage].img.src=this.images[this.currimage].path}else{if(this.currfont<this.fonts.length){this.fonts[this.currfont].data=loadString(this.fonts[this.currfont].path);this.currfont+=1;this.assetcurrent+=1;this.startPreLoad()}else{if(this.currxml<this.xmls.length){this.xmls[this.currxml].data=loadString(this.xmls[this.currxml].path);this.currxml+=1;this.assetcurrent+=1;this.startPreLoad()}else{if(this.currjson<this.jsons.length){this.jsons[this.currjson].data=JSON.parse(loadString(this.jsons[this.currjson].path));this.currjson+=1;this.assetcurrent+=1;this.startPreLoad()}else{if(this.currimage==this.images.length&&this.assetcount==this.assetcurrent){this.ready=true;Game.create()}}}}}},progressScreen:function(d){var b=(Game.bound.width-this.width)/2;var e=(Game.bound.height-this.height)/2;if(this.image){Game.b_ctx.drawImage(this.image,0,0,this.image.width,this.image.height)}else{Game.b_ctx.clearRect(0,0,Game.bound.width,Game.bound.height)}Game.b_ctx.save();Game.b_ctx.fillStyle=this.progresscolor;Game.b_ctx.fillRect((Game.bound.width-this.width)/2,(Game.bound.height-this.height)/2,this.width/100*d,this.height);Game.b_ctx.strokeStyle=this.bordercolor;Game.b_ctx.shadowColor=this.shadowcolor;Game.b_ctx.shadowBlur=this.shadowblur;Game.b_ctx.shadowOffsetX=this.shadowoffsetx;Game.b_ctx.shadowOffsetY=this.shadowoffsety;Game.b_ctx.beginPath();Game.b_ctx.moveTo(b+this.radius,e);Game.b_ctx.lineTo(b+this.width-(1*this.radius),e);Game.b_ctx.arcTo(b+this.width,e,b+this.width,e+this.radius,this.radius);Game.b_ctx.arcTo(b+this.width,this.radius*2+e,b+this.width-(1*this.radius),this.radius*2+e,this.radius);Game.b_ctx.lineTo(b+this.radius,2*this.radius+e);Game.b_ctx.arcTo(b,2*this.radius+e,b,e,this.radius);Game.b_ctx.arcTo(b,e,2*this.radius+b,e,this.radius);Game.b_ctx.lineWidth=this.linewidth;Game.b_ctx.stroke();Game.b_ctx.restore()}});function MediaAssetException(b){this.message=b}CG.Entity.extend("Font",{init:function(){this.atlas=new Image();this.fieldname="";this.initText="";this.chars=new Array(256);this.x=new Array(256);this.y=new Array(256);this.width=new Array(256);this.height=new Array(256);this.xoff=new Array(256);this.yoff=new Array(256);this.xadv=new Array(256);this.lineHeight=0;this.face="";this.size=0;this.bold=0;this.italic=0;this.base=0;this.scaleW=0;this.scaleH=0;return this},update:function(){throw {name:"Font Error",message:"TODO, not defined yet."}},draw:function(f,d,g){currx=0;curry=0;c=0;currx=d;curry=g;for(var e=0,b=f.length;e<b;e++){Game.b_ctx.drawImage(this.atlas,this.x[f.charCodeAt(e)],this.y[f.charCodeAt(e)],this.width[f.charCodeAt(e)],this.height[f.charCodeAt(e)],currx,curry+this.yoff[f.charCodeAt(e)],this.width[f.charCodeAt(e)],this.height[f.charCodeAt(e)]);currx+=this.xadv[f.charCodeAt(e)]}},getLineHeight:function(){return this.lineHeight},getFontSize:function(){return this.size},getLength:function(f){var d=0;var g=0;for(var e=0,b=f.length;e<b;e++){d+=this.xadv[f.charCodeAt(e)]}return d},loadFont:function(j){idnum=0;if(typeof j=="string"){this.initText=loadString(j)}else{this.initText=j.data}var e=this.initText.split("\n");for(l in e){line=e[l].trim();if(line.startsWith("info")||line==""){var k=line.split(" ");for(i in k){var H=k[i];if(H.startsWith("face=")){var z=H.split("=");this.face=z[1].split('"').join("")}if(H.startsWith("size=")){var C=H.split("=");this.size=parseInt(C[1])}if(H.startsWith("bold=")){var E=H.split("=");this.bold=parseInt(E[1])}if(H.startsWith("italic=")){var n=H.split("=");this.italic=parseInt(n[1])}}}if(line.startsWith("padding")){continue}if(line.startsWith("common")){var q=line.split(" ");for(c in q){var B=q[c];if(B.startsWith("lineHeight=")){var J=B.split("=");this.lineHeight=parseInt(J[1])}if(B.startsWith("base=")){var r=B.split("=");this.base=parseInt(r[1])}if(B.startsWith("scaleW=")){var I=B.split("=");this.scaleW=parseInt(I[1])}if(B.startsWith("scaleH=")){var m=B.split("=");this.scaleH=parseInt(m[1])}}}if(line.startsWith("page")){var f=line.split(" ");for(p in f){data=f[p];if(data.startsWith("file=")){var v=data.split("=");this.atlas.src="media/font/"+v[1].split('"').join("")}}}if(line.startsWith("chars")){continue}if(line.startsWith("char")){var A=line.split(" ");for(l in A){ld=A[l];if(ld.startsWith("id=")){var b=ld.split("=");idnum=parseInt(b[1])}if(ld.startsWith("x=")){var F=ld.split("=");this.x[idnum]=parseInt(F[1])}if(ld.startsWith("y=")){var g=ld.split("=");this.y[idnum]=parseInt(g[1])}if(ld.startsWith("width=")){var y=ld.split("=");this.width[idnum]=parseInt(y[1])}if(ld.startsWith("height=")){var u=ld.split("=");this.height[idnum]=parseInt(u[1])}if(ld.startsWith("xoffset=")){var d=ld.split("=");this.xoff[idnum]=parseInt(d[1])}if(ld.startsWith("yoffset=")){var D=ld.split("=");this.yoff[idnum]=parseInt(D[1])}if(ld.startsWith("xadvance=")){var G=ld.split("=");this.xadv[idnum]=parseInt(G[1])}}}}return this}});CG.Class.extend("Director",{init:function(){this.screens=[];this.activescreen=0;this.nextscreen=0;this.duration=20;this.alpha=0;this.fademode="fade";this.color="rgb(0,0,0)";return this},update:function(){switch(this.fademode){case"scale":if(this.nextscreen!=this.activescreen){this.screens[this.activescreen].xscale-=0.4/this.duration;this.screens[this.activescreen].yscale-=0.4/this.duration}else{if(this.nextscreen==this.activescreen){this.screens[this.activescreen].xscale+=0.4/this.duration;this.screens[this.activescreen].yscale+=0.4/this.duration}}if(this.screens[this.activescreen].xscale>=1){this.screens[this.activescreen].xscale=this.screens[this.activescreen].yscale=1;this.screens[this.nextscreen].xscale=this.screens[this.nextscreen].yscale=1}if(this.screens[this.activescreen].xscale<=0){this.screens[this.activescreen].xscale=this.screens[this.activescreen].yscale=1;this.screens[this.nextscreen].xscale=this.screens[this.nextscreen].yscale=0;this.activescreen=this.nextscreen}break;case"fade":if(this.nextscreen!=this.activescreen&&this.alpha<1){this.alpha+=1/this.duration}else{if(this.nextscreen==this.activescreen&&this.alpha!=0){this.alpha-=1/this.duration}}if(this.alpha>=1){this.activescreen=this.nextscreen;this.alpha=1}if(this.alpha<0){this.alpha=0}break}this.screens[this.activescreen].update()},draw:function(){this.screens[this.activescreen].draw();if(this.alpha>0){Game.b_ctx.save();Game.b_ctx.globalAlpha=this.alpha;Game.b_ctx.fillStyle=this.color;Game.b_ctx.fillRect(0,0,Game.bound.width,Game.bound.height);Game.b_ctx.restore()}},addScreen:function(b){this.screens.push(b);return this},nextScreen:function(b,d){if(this.getIndexOfScreen(b)!=this.activescreen){this.duration=d;this.nextscreen=this.getIndexOfScreen(b)}},getScreenByName:function(e){for(var d=0,b=this.screens.length;d<b;d++){if(this.screens[d].name==e){return this.screens[d]}}return false},getIndexOfScreen:function(e){for(var d=0,b=this.screens.length;d<b;d++){if(this.screens[d].name==e){return d}}return false},getActiveScreenName:function(){return this.screens[this.activescreen].name},setFadeMode:function(b){if(b=="scale"){this.fademode=b;this.alpha=0}else{if(b=="fade"){this.fademode=b}}return this}});CG.Entity.extend("Screen",{init:function(d){this._super(d);this.xscale=1;this.yscale=1;var b=this;this.layers=[];return this},create:function(){},update:function(){this.layers.forEach(function(d,b){d.update()},this)},draw:function(){Game.b_ctx.save();if(this.xscale!==1||this.yscale!==1){Game.b_ctx.translate((Game.width-(Game.width*this.xscale))/2,(Game.height-(Game.height*this.yscale))/2);Game.b_ctx.scale(this.xscale,this.yscale)}this.layers.forEach(function(d,b){d.draw()},this);Game.b_ctx.restore()},addLayer:function(b){this.layers.push(b);return this},getLayerByName:function(e){for(var d=0,b=this.layers.length;d<b;d++){if(this.layers[d].name==e){return this.layers[d]}}return false}});CG.Entity.extend("Layer",{init:function(d){this._super(d);var b=this;this.elements=[];this.elementsToDelete=[];return this},update:function(){if(this.visible==true){this.elements.forEach(function(d,b){d.update();if(d.status==1){this.elementsToDelete.push(b)}},this);if(this.elementsToDelete.length>0){this._deleteElements()}}},draw:function(){if(this.visible==true){this.elements.forEach(function(b){b.draw()},this)}},_deleteElements:function(){this.elementsToDelete.reverse();this.elementsToDelete.forEach(this._deleteElement,this);this.elementsToDelete=[]},_deleteElement:function(b){this.elements.splice(b,1)},addElement:function(b){this.elements.push(b);return this},getElementByName:function(d){for(var e=0,b=this.elements.length;e<b;e++){if(this.elements[e].name==d){return this.elements[e]}}return false},getElementsByName:function(d){elements=[];for(var e=0,b=this.elements.length;e<b;e++){if(this.elements[e].name==d){elements.push(this.elements[e])}}return elements}});CG.Class.extend("MapTileLayer",{init:function(){this.width=0;this.height=0;this.visible=true;this.opacity=1;this.tiles=[];return this}});CG.Class.extend("MapTileProperties",{init:function(){this.animated=false;this.animDelay=0;this.animDirection=0;this.animNext=0;this.delayTimer=0;return this}});CG.Class.extend("MapPoint",{init:function(b,f,d,e){this.initposition=b||new CG.Point(0,0);this.mapoffset=f||new CG.Point(0,0);this.gid=e;this.name=d;this.position=new CG.Point(b.x,b.y);return this},update:function(){this.position.x=this.initposition.x-this.mapoffset.x;this.position.y=this.initposition.y-this.mapoffset.y}});CG.Class.extend("MapArea",{init:function(f,e,b,d){this.initbound=f||new CG.Bound(0,0,0,0);this.mapoffset=e||new CG.Point(0,0);this.name=b;this.type=d||false;this.bound=new CG.Bound(f.x,f.y,f.width,f.height);return this},update:function(){this.bound.x=this.initbound.x-this.mapoffset.x;this.bound.y=this.initbound.y-this.mapoffset.y}});CG.Entity.extend("Map",{init:function(d,b,e){this._super(e);this.elements=[];this.points=[];this.areas=[];this.position=new CG.Point(0,0);this.changemap="";this.animated=false;this.animDelayFactor=20;this.atlas=new Image();this.atlaswidth=0;this.atlasheight=0;this.atlastranscol="";if(typeof(ejecta)=="undefined"){this.xml="";this.parser=new DOMParser();this.xmlDoc=""}this.json={};this.layers=[];this.renderlayer="all";this.tileproperties=[];this.orientation="";this.width=0;this.height=0;this.tilewidth=0;this.tileheight=0;this.tileset={tilewidth:0,tileheight:0,offsetx:0,offsety:0,spacing:0,margin:0};this.xspeed=0;this.yspeed=0;this.xscale=1;this.yscale=1;this.alpha=1;this.wrapX=false;this.wrapY=false;this.layertocheck=0;return this},loadMapXml:function(f){this.changemap="";this.animated=false;this.layers=[];if(typeof f=="string"){this.xml=loadString(f)}else{this.xml=f.data}this.removeJsonData();this.xmlDoc=this.parser.parseFromString(this.xml,"text/xml");var D=map.xmlDoc.getElementsByTagName("map")[0];this.orientation=D.getAttribute("orientation");this.width=parseInt(D.getAttribute("width"));this.height=parseInt(D.getAttribute("height"));this.tilewidth=parseInt(D.getAttribute("tilewidth"));this.tileheight=parseInt(D.getAttribute("tileheight"));var n=D.childElementCount;var e=D.firstElementChild;for(i=0;i<n;i++){console.log(">"+e.nodeName);switch(e.nodeName){case"tileset":this.tileset.tilewidth=parseInt(e.getAttribute("tilewidth"));this.tileset.tileheight=parseInt(e.getAttribute("tileheight"));if(e.getAttribute("spacing")){this.tileset.spacing=parseInt(e.getAttribute("spacing"))}if(e.getAttribute("margin")){this.tileset.margin=parseInt(e.getAttribute("margin"))}if(e.getElementsByTagName("tileoffset")[0]){this.tileset.offsetx=parseInt(e.getElementsByTagName("tileoffset")[0].getAttribute("x"));this.tileset.offsety=parseInt(e.getElementsByTagName("tileoffset")[0].getAttribute("y"))}var q=e.getElementsByTagName("image")[0];this.atlas.src="media/map/"+q.getAttribute("source");this.atlaswidth=parseInt(q.getAttribute("width"));this.atlasheight=parseInt(q.getAttribute("height"));this.atlastranscol=q.getAttribute("trans");break;case"layer":var g=new CG.MapTileLayer();data=e.getElementsByTagName("data")[0];if(data.getAttribute("encoding")=="csv"){g.tiles=data.textContent.replace(/(\r\n|\n|\r)/gm,"").split(",");console.log("map encoding csv [layer "+i+"]")}else{if(data.getAttribute("encoding")=="base64"&&data.getAttribute("compression")=="gzip"){throw"base64 gzip compressed map format not supported at the moment"}else{if(data.getAttribute("encoding")=="base64"&&data.getAttribute("compression")=="zlib"){throw"base64 zlib compressed map format not supported at the moment"}else{if(data.getAttribute("encoding")=="base64"){throw"base64 map format not supported at the moment"}else{console.log("map encoding xml [layer "+i+"]");var B=e.getElementsByTagName("tile");for(x in B){if(x<B.length){g.tiles[x]=parseInt(B[x].getAttribute("gid"))}}}}}}g.name=e.getAttribute("name");g.width=parseInt(e.getAttribute("width"));g.height=parseInt(e.getAttribute("height"));if(e.getAttribute("opacity")){g.opacity=parseFloat(e.getAttribute("opacity"))}if(e.getAttribute("visible")==="0"){g.visible=false}this.layers.push(g);break;case"objectgroup":console.log("grouplayer found");var b=e.getElementsByTagName("object");for(o in b){if(o<b.length){var m=b[o];var E=m.getAttribute("name");if(m.getAttribute("gid")){this.points.push(new CG.MapPoint(new CG.Point(parseInt(m.getAttribute("x")),parseInt(m.getAttribute("y"))),this.position,m.getAttribute("name"),parseInt(m.getAttribute("gid"))));console.log("tile as oject found: "+E);console.log(m)}else{if(m.getAttribute("width")){type=false;k=m.getElementsByTagName("property");console.log(k.length);for(var r=0,y=k.length;r<y;r++){if(k[r].getAttribute("name")=="type"){type=k[r].getAttribute("value")}}this.areas.push(new CG.MapArea(new CG.Bound(parseInt(m.getAttribute("x")),parseInt(m.getAttribute("y")),parseInt(m.getAttribute("width")),parseInt(m.getAttribute("height"))),this.position,m.getAttribute("name"),type));console.log("group object found: "+E);console.log(m)}else{if(m.getElementsByTagName("polygon").length>0){console.log("polygon found: "+E)}else{if(m.getElementsByTagName("polyline").length>0){console.log("polyline found: "+E)}}}}}}break}e=e.nextElementSibling}this.tileproperties=Array(parseInt((this.atlaswidth/this.tilewidth))*parseInt((this.atlasheight/this.tileheight)));var B=map.xmlDoc.getElementsByTagName("tileset")[0].getElementsByTagName("tile");var j=new Date().getTime();for(i in B){var z=new CG.MapTileProperties();var C=B[i];if(i<this.tileproperties.length){var u=C.getAttribute("id");var k=C.getElementsByTagName("properties")[0].getElementsByTagName("property");for(r in k){if(r<k.length){var d=k[r];var A=d.getAttribute("name");var v=d.getAttribute("value");if(A=="name"){z.name=v}else{if(A=="anim_delay"){z.animDelay=parseInt(v);z.delayTimer=j;this.animated=true}else{if(A=="anim_direction"){z.animDirection=parseInt(v)}else{if(A=="anim_next"){z.animNext=parseInt(v);z.animated=true}}}}}}this.tileproperties[u]=z}}return this},loadMapJson:function(d){this.changemap="";this.animated=false;this.layers=[];if(typeof d=="string"){this.json=JSON.parse(loadString(d))}else{this.json=d.data}this.removeXmlData();this.orientation=this.json.orientation;this.width=this.json.width;this.height=this.json.height;this.tilewidth=this.json.tilewidth;this.tileheight=this.json.tileheight;for(i=0,l=this.json.layers.length;i<l;i++){switch(this.json.layers[i].type){case"tilelayer":var m=new CG.MapTileLayer();m.tiles=this.json.layers[i].data;m.name=this.json.layers[i].name;m.width=this.json.layers[i].width;m.height=this.json.layers[i].height;m.opacity=this.json.layers[i].opacity;m.visible=this.json.layers[i].visible;this.layers.push(m);break;case"objectgroup":console.log("grouplayer found");var k=this.json.layers[i].objects;for(o in k){if(o<k.length){var f=k[o];var b=f.name;if(f.gid){this.points.push(new CG.MapPoint(new CG.Point(parseInt(f.x),parseInt(f.y)),this.position,f.name,parseInt(f.gid)));console.log("tile as oject found: "+b);console.log(f)}else{if(f.width){this.areas.push(new CG.MapArea(new CG.Bound(parseInt(f.x),parseInt(f.y),parseInt(f.width),parseInt(f.height)),this.position,f.name,f.properties.type));console.log("group object found: "+b);console.log(f)}else{if(f.polygon){console.log("polygon found: "+b)}else{if(f.polyline){console.log("polyline found: "+b)}}}}}}break}}this.atlas.src="media/map/"+this.json.tilesets[0].image;this.atlaswidth=this.json.tilesets[0].imagewidth;this.atlasheight=this.json.tilesets[0].imageheight;this.atlastranscol=this.json.tilesets[0].transparentcolor;this.tileproperties=Array(parseInt((this.atlaswidth/this.tilewidth))*parseInt((this.atlasheight/this.tileheight)));var j=this.json.tilesets[0].tileproperties;var e=new Date().getTime();for(id in j){var n=new CG.MapTileProperties();var g=j[id];n.name=g.name;n.animDelay=parseInt(g.anim_delay);n.delayTimer=(n.animDelay>0)?e:0;n.animated=(n.animDelay>0)?true:false;n.animNext=parseInt(g.anim_next);if(n.animDelay>0){this.animated=true}n.animDirection=parseInt(g.anim_direction);this.tileproperties[id]=n}return this},drawMap:function(A,v,E,D,F,d,n){this.position.x=E;this.position.y=D;this.bx=E||this.bx||0;this.by=D||this.by||0;this.bw=F||Game.bound.width;this.bh=d||Game.bound.height;this.sx=A||this.sx||0;this.sy=v||this.sy||0;this.callback=n||false;this.updatePointsAndAreas();if(this.changemap!=""){this.loadMap(this.changemap)}if(this.visible){this.updateAnimation();if(this.layers.length>0){for(var H=0,C=this.layers.length;H<C;H++){var j=this.layers[H];if(this.renderlayer==j.name||this.renderlayer==H||this.renderlayer=="all"){if(this.orientation=="orthogonal"&&j.visible==true){modx=(this.bx*this.xscale)%this.tilewidth;mody=(this.by*this.yscale)%this.tileheight;r=this.by;my=Math.floor(parseFloat(this.by)/parseFloat(this.tileheight))>>0;var b=(this.by+this.bh+this.tileheight);while(r<b){x=this.bx;mx=Math.floor(parseFloat(this.bx)/parseFloat(this.tilewidth))>>0;var f=(this.bx+this.bw+this.tilewidth);while(x<f){if((this.wrapX||(mx>=0&&mx<this.width))&&(this.wrapY||(my>=0&&my<this.height))){mx2=mx;my2=my;while(mx2<0){mx2+=this.width}while(mx2>=this.width){mx2-=this.width}while(my2<0){my2+=this.height}while(my2>=this.height){my2-=this.height}z=j.tiles[mx2+my2*j.width]-1;if(z>=0){if(modx<0){modx+=this.tilewidth}if(mody<0){mody+=this.tileheight}m=x-modx-this.bx;k=r-mody-this.by;if(this.elements.length>0&&this.layertocheck==C){for(var B=0,C=this.elements.length;B<C;B++){if(this.checkMapCollision(this.elements[0],m,k)){this.callback(this.elements[B],this.tileproperties[z])}}}cx=(z%(this.atlaswidth/this.tilewidth))*this.tilewidth;cy=Math.floor(this.tilewidth*z/this.atlaswidth)*this.tileheight;Game.b_ctx.save();Game.b_ctx.globalAlpha=this.layers[H].opacity;Game.b_ctx.translate(m,k);try{Game.b_ctx.drawImage(this.atlas,cx,cy,this.tilewidth,this.tileheight,this.sx,this.sy,this.tilewidth*this.xscale,this.tileheight*this.yscale)}catch(G){}Game.b_ctx.restore()}}x=x+this.tilewidth;mx+=1}r=r+this.tileheight;my+=1}}else{if(this.orientation=="isometric"){var u=j.width+j.height;for(var r=0;r<u;r++){var k=r;var m=0;while(k>=j.height){k-=1;m+=1}while(k>=0&&m<j.width){var z=j.tiles[m+k*j.width];var g=(m-k-1)*this.tilewidth/2-E;var q=(m+k+1)*this.tileheight/2-D;if(g>-this.tileset.tilewidth&&g<F&&q>-this.tileset.tileheight&&q<d){if(z>0){cx=((z-1)%(this.atlaswidth/this.tilewidth))*this.tilewidth;cy=Math.floor(this.tilewidth*(z-1)/this.atlaswidth)*this.tileset.tileheight;Game.b_ctx.save();Game.b_ctx.globalAlpha=this.layers[H].opacity;Game.b_ctx.translate(g,q);try{Game.b_ctx.drawImage(this.atlas,cx,cy,this.tilewidth,this.tileset.tileheight,0,0,this.tilewidth*this.xscale,this.tileset.tileheight*this.yscale)}catch(G){}Game.b_ctx.restore()}}k-=1;m+=1}}}}}}}}},updatePointsAndAreas:function(){this.points.forEach(function(b,d){b.update()},this);this.areas.forEach(function(d,b){d.update()},this)},getPointsByName:function(d){points=[];for(var e=0,b=this.points.length;e<b;e++){if(this.points[e].name===d){points.push(this.points[e])}}if(points.length>0){return points}return false},getAreasByName:function(d){areas=[];for(var e=0,b=this.areas.length;e<b;e++){if(this.areas[e].name===d){areas.push(this.areas[e])}}if(areas.length>0){return areas}return false},setLayerToRender:function(b){this.renderlayer=b;return this},update:function(){this.bx+=this.xspeed;this.by+=this.yspeed;if(this.getBounds().width-Game.bound.width<this.bx){this.xspeed=this.xspeed*-1}if(this.bx<0){this.xspeed=this.xspeed*-1}if(this.getBounds().height-Game.bound.height<this.by){this.yspeed=this.yspeed*-1}if(this.by<0){this.yspeed=this.yspeed*-1}return this},draw:function(){this.drawMap(this.bx,this.by,this.bw,this.bh,this.sx,this.sy,this.callback);return this},getBounds:function(){return{width:this.width*this.tilewidth,height:this.height*this.tileheight}},updateAnimation:function(){if(this.visible&&this.animated){if(this.layers.length>0){for(var f=0,b=this.layers.length;f<b;f++){var k=new Date().getTime();for(t=0;t<this.layers[f].tiles.length;t++){var g=this.layers[f].tiles[t];if(g>0){try{var d=this.tileproperties[g-1];if(d.animated&&d.animDirection!=0){if(k>(d.delayTimer+(d.animDelay/this.animDelayFactor))){switch(d.animDirection){case 1:this.layers[f].tiles[t]+=d.animNext;this.tileproperties[g-1+d.animNext].delayTimer=k;break;case -1:this.layers[f].tiles[t]-=d.animNext;this.tileproperties[g-1-d.animNext].delayTimer=k;break;default:break}}}}catch(j){}}}}}}},addElement:function(b){this.elements.push(b);return this},checkMapCollision:function(b,e,d){if(b.boundingradius>0){xr=b.boundingradius/2*b.xscale;yr=b.boundingradius/2*b.yscale;if(b.position.x+xr>=e&&b.position.x-xr<=e+this.tilewidth&&b.position.y+yr>=d&&b.position.y-yr<=d+this.tileheight){return true}}else{xw=b.width/2*b.xscale;yh=b.height/2*b.yscale;if(b.position.x+xw>=e&&b.position.x-xw<=e+this.tilewidth&&b.position.y+yh>=d&&b.position.y-yh<=d+this.tileheight){return true}}return false},checkElementsToAreasCollision:function(f,e){for(var d=0,b=f.length;d<b;d++){obj=f[d].checkCollision(this.areas,e)}return this},removeJsonData:function(){this.json={};return this},removeXmlData:function(){this.xml="";this.xmlDoc="";return this}});CG.Entity.extend("Sequence",{init:function(b){this._super(b);this.current=0;this.loop=false;this.translations=[];return this},addTranslation:function(b){this.translations.push(b);return this},update:function(b){if(this.current<this.translations.length){if(this.translations[this.current].finished===false){this.translations[this.current].update()}else{this.current+=1}}else{if(this.loop){this.reset()}else{}}},draw:function(){},reset:function(){for(var d=0,b=this.translations.length;d<b;d++){this.translations[d].reset()}this.current=0;return this}});CG.Entity.extend("Translate",{init:function(){this._super();this.type="";this.tx=0;this.ty=0;this.x1=0;this.y1=0;this.x2=0;this.y2=0;this.bx=0;this.by=0;this.theobj={};this.r1=0;this.r2=0;this.startangle=0;this.angle=0;this.speed=0;this.steps=0;this.step=0;this.positions=[];this.finished=false;return this},initTween:function(f,k,b,n){this.type="tween";this.theobj=f;this.steps=k;this.x1=b.x;this.y1=b.y;this.x2=n.x;this.y2=n.y;var m=(this.x2-this.x1)/this.steps;var j=(this.y2-this.y1)/this.steps;var g=this.x1>>0;var d=this.y1>>0;for(var e=0;e<=this.steps;e++){this.positions.push(new CG.Point(g,d));g+=m;d+=j}return this},initOval:function(g,f,e,b,j,d){this.type="oval";this.theobj=g;this.x1=f.x;this.y1=f.y;this.r1=e;this.r2=b;this.startangle=j;this.speed=d;return this},initBezier:function(j,f,b,k,e,d){this.type="bezier";this.theobj=j;this.steps=f;this.start=k;this.end=b;if(this.control2=="undefined"&&this.control1=="undefined"){this.control2=new CG.Point(this.start.x+3*(this.end.x-this.start.x)/4,this.start.y+3*(this.end.y-this.start.y)/4)}else{this.control2=d||e}this.control1=e||new CG.Point(this.start.x+(this.end.x-this.start.x)/4,this.start.y+(this.end.y-this.start.y)/4);b1=function(n){return(n*n*n)};b2=function(n){return(3*n*n*(1-n))};b3=function(n){return(3*n*(1-n)*(1-n))};b4=function(n){return((1-n)*(1-n)*(1-n))};for(var g=0;g<=this.steps;g++){percent=(1/this.steps)*g;var m=new CG.Point();m.x=this.start.x*b1(percent)+this.control1.x*b2(percent)+this.control2.x*b3(percent)+this.end.x*b4(percent);m.y=this.start.y*b1(percent)+this.control1.y*b2(percent)+this.control2.y*b3(percent)+this.end.y*b4(percent);this.positions.push(m)}return this},draw:function(){},update:function(){var d=this.theobj;switch(this.type){case"bezier":case"tween":if(this.step<this.steps){d.position.x=d.position._x=this.positions[this.step].x;d.position.y=d.position._y=this.positions[this.step].y;this.step+=1}else{this.finished=true}break;case"oval":var b=this.startangle*CG.Const_PI_180;this.tx=this.x1-(this.r1*Math.cos(b));this.ty=this.y1-(this.r2*Math.sin(b));this.startangle+=this.speed;if(this.startangle>360){this.startangle=0+(this.startangle-360)}d.position.x=d.position._x=this.tx>>0;d.position.y=d.position._y=this.ty>>0;break;default:break}},draw:function(){},reset:function(){this.step=0;this.finished=false}});CG.Entity.extend("Morph",{init:function(f,d,b,e){this.mode=f;this.min=d;this.max=b;this.speed=e;this.angle=0;this.rad=this.max-this.min;this.val=0},update:function(){switch(this.mode){case"sinus":var b=this.angle*CG.Const_PI_180;this.val=this.rad*Math.sin(b);if(this.val<0){this.val=this.val*-1}this.angle+=this.speed;if(this.angle>360){this.angle=0+(this.angle-360)}break}return this},draw:function(){},getVal:function(){return this.val}});CG.Sprite.extend("Particle",{init:function(b){this._super(b,new CG.Point(0,0));this.lifetime=100;this.currtime=this.lifetime;this.aging=1;this.fadeout=false;this.alpha=1;this.gravity=0},update:function(){if(this.visible){if(this.fadeout){this.alpha=this.currtime/this.lifetime;if(this.alpha<=0){this.visible=false}}this.currtime-=this.aging;if(this.currtime<0){this.visible=false}this.position.x+=this.xspeed;this.position.y+=this.yspeed;this.yspeed+=this.gravity;this.rotation+=this.rotationspeed}},draw:function(){if(this.visible){Game.b_ctx.save();Game.b_ctx.globalAlpha=this.alpha;Game.b_ctx.translate(this.position.x,this.position.y);if(this.atlasimage){Game.b_ctx.rotate((this.rotation-this.imagerotation)*CG.Const_PI_180);Game.b_ctx.drawImage(this.image,this.xoffset,this.yoffset,this.cutwidth,this.cutheight,0-(this.cutwidth/2),0-(this.cutheight/2),this.cutwidth*this.xscale,this.cutheight*this.yscale);Game.b_ctx.rotate((this.rotation+this.imagerotation)*CG.Const_PI_180)}else{Game.b_ctx.rotate(this.rotation*CG.Const_PI_180);Game.b_ctx.drawImage(this.image,0-(this.image.width*this.xscale/2),0-(this.image.height*this.yscale/2),this.image.width*this.xscale,this.image.height*this.yscale)}Game.b_ctx.restore()}}});CG.Entity.extend("Emitter",{init:function(b){this._super();this.particles=[];this.maxparticles=50;this.creationtime=100;this.currenttime=0;this.creationspeed=50;this.gravity=0.05;this.image=null;this.type="";this.position=b||new CG.Point(0,0);this.position._x=this.position.x;this.position._y=this.position.y;this.rotation=0;this.width=200;this.height=200;this.radius=0;this.pspeed=10;this.protation=0;this.pdirection=0;this.plifetime=100;this.paging=1;this.pfadeout=false;return this},initAsPoint:function(b){this.image=b;this.type="point";return this},initAsExplosion:function(e,d,b){this.image=e;this.type="explosion";this.min=d;this.max=b;return this},initAsCorona:function(d,b){this.image=d;this.type="corona";this.radius=b||0;return this},initAsLine:function(e,b,d){this.image=e;this.width=b||200;this.pdirection=d||CG.UP;this.type="line";return this},initAsRectangle:function(e,d,b){this.image=e;this.width=d||200;this.height=b||200;this.type="rectangle";return this},createParticle:function(){particle=new CG.Particle(this.image);return particle},initParticle:function(d){if(this.pfadeout){d.fadeout=true}d.gravity=this.gravity;d.alpha=1;d.visible=true;d.lifetime=this.plifetime;d.currtime=this.plifetime;d.rotationspeed=this.protation;switch(this.type){case"corona":var b=this.getRandom(0,359)*CG.Const_PI_180;d.position.x=this.getX()-(this.radius*Math.cos(b));d.position.y=this.getY()-(this.radius*Math.sin(b));angl=Math.atan2(d.position.x-this.getX(),d.position.y-this.getY())*CG.Const_180_PI;d.xspeed=this.pspeed*Math.sin(angl*CG.Const_PI_180);d.yspeed=this.pspeed*Math.cos(angl*CG.Const_PI_180);break;case"rectangle":rndx=this.getRandom(this.width/2*-1,this.width/2);rndy=this.getRandom(this.height/2*-1,this.height/2);d.position.x=this.position._x-rndx;d.position.y=this.position._y-rndy;d.xspeed=0;d.yspeed=0;break;case"line":rnd=this.getRandom(this.width/2*-1,this.width/2);switch(this.pdirection){default:case CG.UP:d.xspeed=0;d.yspeed=this.pspeed*-1;d.position.x=rnd+this.getX();d.position.y=this.position._y;break;case CG.DOWN:d.xspeed=0;d.yspeed=this.pspeed;d.position.x=rnd+this.getX();d.position.y=this.position._y;break;case CG.LEFT:d.xspeed=this.pspeed*-1;d.yspeed=0;d.position.x=this.position._x;d.position.y=rnd+this.getY();break;case CG.RIGHT:d.xspeed=this.pspeed;d.yspeed=0;d.position.x=this.position._x;d.position.y=rnd+this.getY();break}break;case"explosion":d.position.x=this.position._x;d.position.y=this.position._y;d.xspeed=this.getRandom(this.min,this.max);d.yspeed=this.getRandom(this.min,this.max);break;case"point":default:d.xspeed=0;d.yspeed=0;d.position.x=this.position._x;d.position.y=this.position._y;break}return d},update:function(){if(this.visible){this.currenttime+=this.creationspeed;if(this.currenttime>=this.creationtime){this.currenttime=0;if(this.particles.length<this.maxparticles){this.particles.push(this.initParticle(this.createParticle()))}else{particle=this.searchInvisibleParticle();this.initParticle(particle);this.particles.sort(function(f,e){return f.currtime-e.currtime})}}for(var d=0,b=this.particles.length;d<b;d++){this.particles[d].update()}return this}},draw:function(){if(this.visible){for(var d=0,b=this.particles.length;d<b;d++){this.particles[d].draw()}return this}},searchInvisibleParticle:function(){for(var d=0,b=this.particles.length;d<b;d++){if(this.particles[d].visible==false){return this.particles[d]}}return this},setEmitterPosition:function(b){this.position=b;return this},setName:function(b){this.name=b;return this},setCreationTime:function(b){this.creationtime=b;return this},setMaxParticles:function(b){this.maxparticles=b;return this},setGravity:function(b){this.gravity=b;return this},setParticleSpeed:function(b){this.pspeed=b;return this},setProtation:function(b){this.protation=b;return this},setPLifetime:function(b){this.plifetime=b;return this},activateFadeout:function(){this.pfadeout=true;return this},deactivateFadeout:function(){this.pfadeout=false;return this},getRandom:function(d,b){return Math.random()*(b-d+1)+d>>0},getX:function(){return this.position._x},getY:function(){return this.position._y}});